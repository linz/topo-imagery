name: Format and Tests
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Use Python "3.10.6"
        uses: actions/setup-python@v4
        with:
          python-version: "3.10.6"
      - name: Install
        run: |
          pip install poetry
          poetry install
      - name: Format
        run: |
          poetry run pre-commit run --all-files
      - name: Unit Tests
        run: |
          poetry run pytest .
      - name: E2E Tests Standardising
        run: |
          poetry run e2e --type all
      - name: End to end test - Thumbnails (Topo50/Topo250)
        run: |
          # FIXME: include this test in `e2e` script
          docker build . --tag topo-imagery --label "github_run_id=${GITHUB_RUN_ID}"
          docker run  -v ${HOME}/tmp/:/tmp/ topo-imagery python3 thumbnails.py --from-file ./tests/data/thumbnails.json --target /tmp/
          cmp --silent ${HOME}/tmp/CB07_GeoTifv1-02-thumbnail.jpg ./scripts/tests/data/output/CB07_GeoTifv1-02-thumbnail.jpg
          cmp --silent ${HOME}/tmp/CB07_TIFFv1-02-thumbnail.jpg ./scripts/tests/data/output/CB07_TIFFv1-02-thumbnail.jpg
